{% extends "base.html" %}

{% block title %}Plato - Review{% endblock %}

{% block content %}
<div class="review-section">
    <h2>Review & Confirm</h2>
    <p>Review the extracted information below. Click any highlighted field to edit it.</p>

    <!-- Summary Section -->
    {% if completeness %}
    <section class="review-section-item summary-section">
        <div class="summary-stats">
            <div class="stat-item">
                <span class="stat-value">{{ completeness.num_assessments }}</span>
                <span class="stat-label">Assessments</span>
            </div>
            <div class="stat-item">
                <span class="stat-value completeness-{{ 'high' if completeness.total_weight >= 95 else 'medium' if completeness.total_weight >= 70 else 'low' }}">{{ "%.0f"|format(completeness.total_weight) }}%</span>
                <span class="stat-label">Weight Found</span>
            </div>
            <div class="stat-item">
                <span class="stat-value">{{ completeness.num_lecture_sections }}</span>
                <span class="stat-label">Lectures</span>
            </div>
            <div class="stat-item">
                <span class="stat-value">{{ completeness.num_lab_sections }}</span>
                <span class="stat-label">Labs</span>
            </div>
        </div>
    </section>
    {% endif %}

    <form action="{{ url_for('review') }}" method="POST" class="review-form" id="review-form">
        <!-- Course Information -->
        <section class="review-section-item">
            <h3>
                <i data-lucide="book-open"></i>
                Course Information
            </h3>
            <div class="info-grid">
                <div>
                    <label>Course Name</label>
                    <span class="value editable-field {% if course_name == 'Not found' %}missing-field{% endif %}" 
                          data-field-type="course_name" 
                          data-current-value="{{ course_name }}"
                          title="Click to edit">
                        {{ course_name }}
                    </span>
                </div>
                <div>
                    <label>Term</label>
                    <span class="value">{{ term.term_name }}</span>
                </div>
                <div>
                    <label>Start Date</label>
                    <span class="value editable-field {% if not term.start_date %}missing-field{% endif %}" 
                          data-field-type="term_start" 
                          data-current-value="{{ term.start_date.strftime('%Y-%m-%d') if term.start_date else '' }}"
                          title="Click to edit">
                        {{ term.start_date.strftime('%b %d, %Y') if term.start_date else 'Not found' }}
                    </span>
                </div>
                <div>
                    <label>End Date</label>
                    <span class="value editable-field {% if not term.end_date %}missing-field{% endif %}" 
                          data-field-type="term_end" 
                          data-current-value="{{ term.end_date.strftime('%Y-%m-%d') if term.end_date else '' }}"
                          title="Click to edit">
                        {{ term.end_date.strftime('%b %d, %Y') if term.end_date else 'Not found' }}
                    </span>
                </div>
            </div>
        </section>

        <!-- Lecture Section Selection -->
        <section class="review-section-item">
            <h3>
                <i data-lucide="users"></i>
                Lecture Section
            </h3>
            {% if lecture_sections %}
                <div class="form-group">
                    <label for="lecture_section">Select your section</label>
                    <select name="lecture_section" id="lecture_section" class="form-control" required>
                        <option value="none">Select a section</option>
                        {% for section in lecture_sections %}
                            <option value="{{ loop.index0 }}" 
                                {% if user_choices.selected_lecture_section and user_choices.selected_lecture_section.section_id == section.section_id %}selected{% endif %}>
                                {% if section.section_id %}Section {{ section.section_id }}: {% endif %}
                                {% if section.days_of_week %}
                                    {% set day_names = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'] %}
                                    {% for day_num in section.days_of_week %}
                                        {{ day_names[day_num] }}{% if not loop.last %}/{% endif %}
                                    {% endfor %}
                                {% else %}
                                    Days N/A
                                {% endif %}
                                {{ section.start_time|time_12h }} - {{ section.end_time|time_12h }}
                                {% if section.location %}({{ section.location }}){% endif %}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            {% else %}
                <p class="no-data">No lecture sections found. Add one manually if needed.</p>
                <button type="button" class="btn btn-tertiary btn-sm" id="add-lecture-section">
                    <i data-lucide="plus"></i>
                    Add Section
                </button>
                <input type="hidden" name="lecture_section" value="none">
            {% endif %}
        </section>

        <!-- Lab Section Selection -->
        <section class="review-section-item">
            <h3>
                <i data-lucide="flask-conical"></i>
                Lab Section
            </h3>
            {% if lab_sections %}
                <div class="form-group">
                    <label for="lab_section">Select your section</label>
                    <select name="lab_section" id="lab_section" class="form-control">
                        <option value="none">No lab section</option>
                        {% for section in lab_sections %}
                            <option value="{{ loop.index0 }}"
                                {% if user_choices.selected_lab_section and user_choices.selected_lab_section.section_id == section.section_id %}selected{% endif %}>
                                Section {{ section.section_id or 'N/A' }}: 
                                {% if section.days_of_week %}
                                    {% set day_names = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'] %}
                                    {% for day_num in section.days_of_week %}
                                        {{ day_names[day_num] }}{% if not loop.last %}/{% endif %}
                                    {% endfor %}
                                {% else %}
                                    Days N/A
                                {% endif %}
                                {% if section.start_time %}{{ section.start_time|time_12h }}{% else %}Time N/A{% endif %}
                                -
                                {% if section.end_time %}{{ section.end_time|time_12h }}{% else %}Time N/A{% endif %}
                                {% if section.location %}({{ section.location }}){% endif %}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            {% else %}
                <p class="no-data">No lab sections found. Add one manually if needed.</p>
                <button type="button" class="btn btn-tertiary btn-sm" id="add-lab-section">
                    <i data-lucide="plus"></i>
                    Add Section
                </button>
                <input type="hidden" name="lab_section" value="none">
            {% endif %}
        </section>

        <!-- Assessments -->
        <section class="review-section-item">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-lg);">
                <h3 style="margin: 0;">
                    <i data-lucide="clipboard-list"></i>
                    Assessments
                </h3>
                <button type="button" class="btn btn-tertiary btn-sm" id="add-assessment-btn">
                    <i data-lucide="plus"></i>
                    Add
                </button>
            </div>
            {% if assessments %}
                <div class="assessments-list">
                    {% for assessment in assessments %}
                        {% set missing_date = not assessment.due_datetime and not assessment.due_rule %}
                        {% set should_flag = assessment.needs_review or missing_date or not assessment.weight_percent %}
                        <div class="assessment-item {% if should_flag %}needs-review{% endif %}" data-assessment-index="{{ loop.index0 }}" data-assessment-id="{{ loop.index0 }}">
                            <div class="assessment-header">
                                <span class="editable-field assessment-title" 
                                      data-field-type="assessment_title" 
                                      data-assessment-index="{{ loop.index0 }}"
                                      data-current-value="{{ assessment.title }}"
                                      title="Click to edit">
                                    <strong>{{ assessment.title }}</strong>
                                </span>
                                {% if should_flag %}
                                    <span class="badge badge-warning">Review</span>
                                {% endif %}
                                <button type="button" class="btn-remove-assessment" data-assessment-index="{{ loop.index0 }}" title="Remove">
                                    <i data-lucide="trash-2"></i>
                                </button>
                            </div>
                            <div class="assessment-details">
                                <span class="editable-field {% if not assessment.weight_percent %}missing-field{% endif %}" 
                                      data-field-type="assessment_weight" 
                                      data-assessment-index="{{ loop.index0 }}"
                                      data-current-value="{{ assessment.weight_percent or '' }}"
                                      title="Click to edit weight">
                                    <i data-lucide="percent"></i>
                                    {% if assessment.weight_percent %}{{ assessment.weight_percent }}%{% else %}Add weight{% endif %}
                                </span>
                                {% if assessment.due_datetime %}
                                    <span class="editable-field" 
                                          data-field-type="assessment_due_date" 
                                          data-assessment-index="{{ loop.index0 }}"
                                          data-current-value="{{ assessment.due_datetime.strftime('%Y-%m-%d %H:%M') if assessment.due_datetime else '' }}"
                                          title="Click to edit date">
                                        <i data-lucide="calendar"></i>
                                        {{ assessment.due_datetime.strftime('%b %d, %Y') }}
                                    </span>
                                {% elif assessment.due_rule %}
                                    <span class="editable-field missing-field" 
                                          data-field-type="assessment_due_date" 
                                          data-assessment-index="{{ loop.index0 }}"
                                          data-current-value=""
                                          title="Click to add date">
                                        <i data-lucide="calendar"></i>
                                        {{ assessment.due_rule[:25] }}{% if assessment.due_rule|length > 25 %}...{% endif %}
                                    </span>
                                {% else %}
                                    <span class="editable-field missing-field" 
                                          data-field-type="assessment_due_date" 
                                          data-assessment-index="{{ loop.index0 }}"
                                          data-current-value=""
                                          title="Click to add date">
                                        <i data-lucide="calendar"></i>
                                        Add date
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="no-data">No assessments found. Add them manually using the button above.</p>
            {% endif %}
        </section>

        <!-- Lead Time Mapping - Collapsible -->
        <details class="review-section-item">
            <summary class="lead-time-summary">
                <i data-lucide="bell"></i>
                <span>Study Reminders</span>
                <i data-lucide="chevron-down" class="chevron"></i>
            </summary>
            <div class="lead-time-content">
                <p>Reminders will be created based on assessment weight. Click to customize.</p>
                <div class="lead-time-mapping">
                    <table>
                        <thead>
                            <tr>
                                <th>Weight Range</th>
                                <th>Reminder</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for range, days in lead_time_mapping.items() %}
                                <tr>
                                    <td>{{ range }}</td>
                                    <td>
                                        <span class="editable-field lead-time-value" 
                                              data-field-type="lead_time_mapping" 
                                              data-weight-range="{{ range }}"
                                              data-current-value="{{ days }}"
                                              title="Click to edit">
                                            {{ days }} days before
                                        </span>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </details>

        <!-- Form Actions -->
        <div class="form-actions">
            <button type="submit" class="btn btn-primary" id="generate-calendar-btn">
                <i data-lucide="download"></i>
                Download Calendar
            </button>
            <a href="{{ url_for('index') }}" class="btn btn-secondary">
                <i data-lucide="arrow-left"></i>
                Back
            </a>
        </div>
    </form>
</div>

<!-- Modal for Adding Assessment -->
<div id="add-assessment-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close-modal">&times;</span>
        <h3>
            <i data-lucide="plus-circle"></i>
            Add Assessment
        </h3>
        <form id="add-assessment-form" onsubmit="return false;">
            <div class="form-group">
                <label for="assessment-title">Title</label>
                <input type="text" id="assessment-title" name="title" required placeholder="e.g., Midterm Exam, Assignment 1">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="assessment-type">Type</label>
                    <select id="assessment-type" name="type" required>
                        <option value="assignment">Assignment</option>
                        <option value="lab_report">Lab Report</option>
                        <option value="quiz">Quiz</option>
                        <option value="midterm">Midterm</option>
                        <option value="final">Final Exam</option>
                        <option value="project">Project</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="assessment-weight">Weight (%)</label>
                    <input type="number" id="assessment-weight" name="weight_percent" step="0.1" min="0" max="100" placeholder="15">
                </div>
            </div>
            <div class="form-group">
                <label for="assessment-due-date">Due Date & Time</label>
                <input type="datetime-local" id="assessment-due-date" name="due_datetime">
            </div>
            <div class="form-group">
                <label for="assessment-due-rule">Relative Date (optional)</label>
                <input type="text" id="assessment-due-rule" name="due_rule" placeholder="e.g., During final exam period">
                <small>Use this if you don't know the exact date yet</small>
            </div>
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                    <i data-lucide="check"></i>
                    Add
                </button>
                <button type="button" class="btn btn-secondary cancel-add-assessment">
                    Cancel
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}
